kind: pipeline
type: docker
name: docker-compose-example

environment:
  GIT_TAG: $(git rev-parse --short HEAD)
  PROJECT: 'live4-data-center-service'
  IMAGE_NAME: 'live4-data-center-drone'

volumes:
  - name: shared-data
    path: /shared-data

steps:
  - name: Set GIT_TAG
    image: plugins/git
    volumes:
    - name: shared-data
      path: /shared-data
    settings:
      credentials:
        from_secret: devops-ssh  # 替换为您保存 GitHub 凭据的 Drone CI Secret 的名称
    commands:
      - export GIT_TAG=$(git rev-parse --short HEAD)
      - echo $GIT_TAG
      - mkdir -p /shared-data  # 创建目录，如果不存在
      - echo "GIT_TAG=$GIT_TAG" >> /shared-data/variables.txt

  - name: Print Environment Variables
    image: alpine
    volumes:
    - name: shared-data
      path: /shared-data
    commands:
      - echo $GIT_TAG
      - cat /shared-data/variables.txt
      - source /shared-data/variables.txt
      - echo Global Variable in Step 2 $GIT_TAG

# environment:
#   GIT_TAG: ''
#   PROJECT: 'live4-data-center-service'
#   IMAGE_NAME: 'live4-data-center-drone'

# steps:

#   - name: checkout
#     image: alpine/git
#     commands:
#       - echo hello $GIT_TAG bye
#       - git clone --recursive https://github.com/bobiMedia/live4-data-center-service.git .
#       - export GIT_TAG=$(git rev-parse --short HEAD)  # 获取 Git 提交的前7个字符作为 TAG
#       - echo "GIT_TAG=${GIT_TAG}" >> $DRONE_ENV_FILE 
#       - echo "GIT_TAG=${GIT_TAG}" > git_tag.txt
#     when:
#       event:
#         exclude:
#           - push

#   - name: generate-random-tag
#     image: bash
#     commands:
#       - echo hello $DRONE_ENV_FILE bye
#       - source git_tag.txt
#       - echo Generated random tag $GIT_TAG